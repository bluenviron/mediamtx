# MediaMTX configuration file

api: yes
apiAddress: 0.0.0.0:9997

# RTSP server configuration
rtspAddress: :8554

# Use TCP transport (matches your transcoder config)
rtspTransports: [tcp]

# RTMP server configuration
rtmpAddress: :1935

# HLS server configuration
hlsAddress: :8888
hlsAlwaysRemux: yes
hlsSegmentDuration: 8s
hlsSegmentCount: 20      
hlsPartDuration: 4000ms
hlsMuxerCloseAfter: 60s   

# WebRTC server configuration
webrtcAddress: :8889

# Internal authentication.
# list of users.
authInternalUsers:
  # Default unprivileged user.
  # Username. 'any' means any user, including anonymous ones.
  - user: any
    # Password. Not used in case of 'any' user.
    pass:
    # IPs or networks allowed to use this user. An empty list means any IP.
    ips: []
    # List of permissions.
    permissions:
      # Available actions are: publish, read, playback, api, metrics, pprof.
      - action: publish
        # Paths can be set to further restrict access to a specific path.
        # An empty path means any path.
        # Regular expressions can be used by using a tilde as prefix.
        path:
      - action: read
        path:
      - action: playback
        path:
      - action: api
        path:

    # Default administrator.
    # This allows to use API, metrics and PPROF without authentication,
    # if the IP is localhost.
  - user: any
    pass:
    ips: ["127.0.0.1", "::1"]
    permissions:
      - action: metrics
      - action: pprof

paths:
  test_pattern/main:
    metadata:
          type: native
          expectedCodec: h264
          expectedBitrate: 2000Kbps
          expectedResolution: 1920x1080
          expectedFPS: 25
    source: publisher
    record: false
    runOnInit: >
      ffmpeg -hide_banner -loglevel warning -re
      -f lavfi -i testsrc2=size=1920x1080:rate=25
      -vf "drawtext=
        font=DejaVu Sans Mono:
        fontsize=56:
        fontcolor=white:
        box=1:
        boxcolor=0x00000099:
        boxborderw=10:
        x=400:
        y=400:
        text='%{localtime\:%Y-%m-%d %H\\\\\:%M\\\\\:%S}.%{eif\\:(t-floor(t))*1000\\:d\\:3}'
      "
      -c:v libx264 -preset ultrafast -tune zerolatency
      -g 25
      -keyint_min 25
      -b:v 2M
      -pix_fmt yuv420p
      -f rtsp rtsp://127.0.0.1:8554/test_pattern/main
    runOnInitRestart: true

  test_pattern/sub:
    metadata:
          type: native
          expectedCodec: h264
          expectedBitrate: 1000Kbps
          expectedResolution: 1280x720
          expectedFPS: 25
          enableInvestigation: yes
    source: publisher
    record: false
    runOnInit: >
      ffmpeg -hide_banner -loglevel warning -re
      -f lavfi -i testsrc2=size=1920x1080:rate=25
      -vf "drawtext=
        font=DejaVu Sans Mono:
        fontsize=56:
        fontcolor=white:
        box=1:
        boxcolor=0x00000099:
        boxborderw=10:
        x=400:
        y=400:
        text='%{localtime\:%Y-%m-%d %H\\\\\:%M\\\\\:%S}.%{eif\\:(t-floor(t))*1000\\:d\\:3}',
        scale=1280:720
      "
      -c:v libx264 -preset ultrafast -tune zerolatency
      -g 25
      -keyint_min 25
      -b:v 1M
      -pix_fmt yuv420p
      -f rtsp rtsp://127.0.0.1:8554/test_pattern/sub
    runOnInitRestart: true
  test_pattern/dilution:
    metadata:
      type: dilution
      expectedCodec: h264
      expectedBitrate: 250Kbps
      expectedResolution: 1280x720
      expectedFPS: 1
    source: rtsp://localhost:8554/test_pattern/sub
    dropNonKeyframes: yes

