package stream

import (
	"bytes"
	"testing"

	"github.com/bluenviron/gortsplib/v5/pkg/description"
	"github.com/bluenviron/gortsplib/v5/pkg/format"
	"github.com/bluenviron/mediacommon/v2/pkg/codecs/mpeg4audio"
	"github.com/bluenviron/mediamtx/internal/conf"
	"github.com/bluenviron/mediamtx/internal/logger"
	"github.com/bluenviron/mediamtx/internal/unit"
	"github.com/pion/rtp"
	"github.com/stretchr/testify/require"
)

type nilLogger struct{}

func (nilLogger) Log(logger.Level, string, ...any) {
}

func TestStream(t *testing.T) {
	desc := &description.Session{Medias: []*description.Media{
		{
			Type:    description.MediaTypeVideo,
			Formats: []format.Format{&format.H264{}},
		},
		{
			Type:    description.MediaTypeVideo,
			Formats: []format.Format{&format.VP8{}},
		},
	}}

	strm := &Stream{
		Desc:              desc,
		WriteQueueSize:    512,
		RTPMaxPayloadSize: 1450,
	}
	err := strm.Initialize()
	require.NoError(t, err)
	defer strm.Close()

	subStream := &SubStream{
		Stream:        strm,
		UseRTPPackets: false,
	}
	err = subStream.Initialize()
	require.NoError(t, err)

	r := &Reader{}

	recv := make(chan struct{})

	r.OnData(desc.Medias[0], desc.Medias[0].Formats[0], func(_ *unit.Unit) error {
		close(recv)
		return nil
	})

	strm.AddReader(r)
	defer strm.RemoveReader(r)

	subStream.WriteUnit(desc.Medias[0], desc.Medias[0].Formats[0], &unit.Unit{
		PTS: 30000 * 2,
		Payload: unit.PayloadH264{
			{5, 2}, // IDR
		},
	})

	<-recv

	require.Equal(t, uint64(14), strm.BytesReceived())
	require.Equal(t, uint64(14), strm.BytesSent())
}

func TestStreamSkipBytesSent(t *testing.T) {
	desc := &description.Session{Medias: []*description.Media{
		{
			Type:    description.MediaTypeVideo,
			Formats: []format.Format{&format.H264{}},
		},
		{
			Type:    description.MediaTypeVideo,
			Formats: []format.Format{&format.VP8{}},
		},
	}}

	strm := &Stream{
		Desc:              desc,
		WriteQueueSize:    512,
		RTPMaxPayloadSize: 1450,
	}
	err := strm.Initialize()
	require.NoError(t, err)
	defer strm.Close()

	subStream := &SubStream{
		Stream:        strm,
		UseRTPPackets: false,
	}
	err = subStream.Initialize()
	require.NoError(t, err)

	r := &Reader{
		SkipBytesSent: true,
	}

	recv := make(chan struct{})

	r.OnData(desc.Medias[0], desc.Medias[0].Formats[0], func(_ *unit.Unit) error {
		close(recv)
		return nil
	})

	strm.AddReader(r)
	defer strm.RemoveReader(r)

	subStream.WriteUnit(desc.Medias[0], desc.Medias[0].Formats[0], &unit.Unit{
		PTS: 30000 * 2,
		Payload: unit.PayloadH264{
			{5, 2}, // IDR
		},
	})

	<-recv

	require.Equal(t, uint64(14), strm.BytesReceived())
	require.Equal(t, uint64(0), strm.BytesSent())
}

func TestStreamResizeOversizedRTPPackets(t *testing.T) {
	desc := &description.Session{Medias: []*description.Media{
		{
			Type: description.MediaTypeVideo,
			Formats: []format.Format{&format.H264{
				SPS: []byte{ // 1920x1080 baseline
					0x67, 0x42, 0xc0, 0x28, 0xd9, 0x00, 0x78, 0x02,
					0x27, 0xe5, 0x84, 0x00, 0x00, 0x03, 0x00, 0x04,
					0x00, 0x00, 0x03, 0x00, 0xf0, 0x3c, 0x60, 0xc9, 0x20,
				},
				PPS: []byte{0x08, 0x06, 0x07, 0x08},
			}},
		},
	}}

	strm := &Stream{
		Desc:              desc,
		WriteQueueSize:    512,
		RTPMaxPayloadSize: 400,
		Parent:            &nilLogger{},
	}
	err := strm.Initialize()
	require.NoError(t, err)
	defer strm.Close()

	subStream := &SubStream{
		Stream:        strm,
		UseRTPPackets: true,
	}
	err = subStream.Initialize()
	require.NoError(t, err)

	r := &Reader{}

	recv := make(chan *unit.Unit)
	n := 0

	r.OnData(desc.Medias[0], desc.Medias[0].Formats[0], func(u *unit.Unit) error {
		switch n {
		case 0:
		case 1:
			recv <- u
		default:
			t.Error("should not happen")
		}
		n++
		return nil
	})

	strm.AddReader(r)
	defer strm.RemoveReader(r)

	subStream.WriteUnit(desc.Medias[0], desc.Medias[0].Formats[0], &unit.Unit{
		PTS: 90000,
		RTPPackets: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         true,
					PayloadType:    96,
					SequenceNumber: 122,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{1, 2, 3, 4},
			},
		},
	})

	oversizedPayload := make([]byte, 1000)
	for i := range oversizedPayload {
		oversizedPayload[i] = byte(i % 256)
	}

	subStream.WriteUnit(desc.Medias[0], desc.Medias[0].Formats[0], &unit.Unit{
		PTS: 90000,
		RTPPackets: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         true,
					PayloadType:    96,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: oversizedPayload,
			},
		},
	})

	received := <-recv

	require.Equal(t, 3, len(received.RTPPackets))

	for i, pkt := range received.RTPPackets {
		require.Equal(t, 123+uint16(i), pkt.SequenceNumber)
		require.Equal(t, uint32(45343), pkt.Timestamp)
	}

	totalPayloadSize := 0
	for _, pkt := range received.RTPPackets {
		require.LessOrEqual(t, len(pkt.Payload), 400)
		totalPayloadSize += len(pkt.Payload)
	}

	require.Equal(t, 1005, totalPayloadSize)
}

func TestStreamUpdateFormatParams(t *testing.T) {
	for _, ca := range []string{"h264", "h265", "mpeg4video"} {
		t.Run(ca, func(t *testing.T) {
			var desc *description.Session
			var media *description.Media
			var forma format.Format
			var u *unit.Unit

			switch ca {
			case "h264":
				sps := []byte{
					0x67, 0x64, 0x00, 0x20, 0xac, 0xd9, 0x40, 0x78,
					0x02, 0x27, 0xe5, 0x9a, 0x80, 0x80, 0x80, 0xa0,
				}
				pps := []byte{0x08, 0x07, 0x08, 0x09}

				formatH264 := &format.H264{
					SPS: []byte{0x67, 0x42, 0xc0, 0x28},
					PPS: []byte{0x08, 0x06},
				}

				desc = &description.Session{Medias: []*description.Media{{
					Type:    description.MediaTypeVideo,
					Formats: []format.Format{formatH264},
				}}}
				media = desc.Medias[0]
				forma = formatH264

				u = &unit.Unit{
					PTS: 90000,
					Payload: unit.PayloadH264{
						sps,    // New SPS
						pps,    // New PPS
						{5, 1}, // IDR
					},
				}

			case "h265":
				vps := []byte{0x40, 0x01, 0x0c, 0x01, 0xff, 0xfe}
				sps := []byte{0x42, 0x01, 0x01, 0x01, 0x60, 0x00, 0x00, 0x04}
				pps := []byte{0x44, 0x01, 0xc1, 0x73, 0xd1, 0x8a}

				formatH265 := &format.H265{
					VPS: []byte{0x40, 0x01, 0x0c},
					SPS: []byte{0x42, 0x01, 0x01},
					PPS: []byte{0x44, 0x01, 0xc1},
				}

				desc = &description.Session{Medias: []*description.Media{{
					Type:    description.MediaTypeVideo,
					Formats: []format.Format{formatH265},
				}}}
				media = desc.Medias[0]
				forma = formatH265

				u = &unit.Unit{
					PTS: 90000,
					Payload: unit.PayloadH265{
						vps,                      // New VPS
						sps,                      // New SPS
						pps,                      // New PPS
						{0x26, 0x01, 0x01, 0x02}, // IDR
					},
				}

			case "mpeg4video":
				config := []byte{
					0x00, 0x00, 0x01, 0xb0, // Visual Object Sequence Start
					0x02, 0x00, 0x00, 0x01, 0xb5, 0x8a,
					0x14, 0x00, 0x00, 0x01, 0x00,
				}

				formatMPEG4Video := &format.MPEG4Video{
					Config: []byte{0x00, 0x00, 0x01, 0xb0, 0x01},
				}

				desc = &description.Session{Medias: []*description.Media{{
					Type:    description.MediaTypeVideo,
					Formats: []format.Format{formatMPEG4Video},
				}}}
				media = desc.Medias[0]
				forma = formatMPEG4Video

				frame := make([]byte, 0, len(config)+20)
				frame = append(frame, config...)
				frame = append(frame, []byte{0x00, 0x00, 0x01, 0xb3}...) // Group of VOP
				frame = append(frame, []byte{0x01, 0x02, 0x03, 0x04}...)

				u = &unit.Unit{
					PTS:     90000,
					Payload: unit.PayloadMPEG4Video(frame),
				}
			}

			strm := &Stream{
				Desc:              desc,
				WriteQueueSize:    512,
				RTPMaxPayloadSize: 1450,
			}
			err := strm.Initialize()
			require.NoError(t, err)
			defer strm.Close()

			subStream := &SubStream{
				Stream:        strm,
				UseRTPPackets: false,
			}
			err = subStream.Initialize()
			require.NoError(t, err)

			r := &Reader{}
			recv := make(chan struct{})

			r.OnData(media, forma, func(_ *unit.Unit) error {
				close(recv)
				return nil
			})

			strm.AddReader(r)
			defer strm.RemoveReader(r)

			subStream.WriteUnit(media, forma, u)

			<-recv

			// Verify that format parameters were updated
			switch ca {
			case "h264":
				formatH264 := forma.(*format.H264)
				require.Equal(t, []byte{
					0x67, 0x64, 0x00, 0x20, 0xac, 0xd9, 0x40, 0x78,
					0x02, 0x27, 0xe5, 0x9a, 0x80, 0x80, 0x80, 0xa0,
				}, formatH264.SPS)
				require.Equal(t, []byte{0x08, 0x07, 0x08, 0x09}, formatH264.PPS)

			case "h265":
				formatH265 := forma.(*format.H265)
				require.Equal(t, []byte{0x40, 0x01, 0x0c, 0x01, 0xff, 0xfe}, formatH265.VPS)
				require.Equal(t, []byte{0x42, 0x01, 0x01, 0x01, 0x60, 0x00, 0x00, 0x04}, formatH265.SPS)
				require.Equal(t, []byte{0x44, 0x01, 0xc1, 0x73, 0xd1, 0x8a}, formatH265.PPS)

			case "mpeg4video":
				formatMPEG4Video := forma.(*format.MPEG4Video)
				require.Equal(t, []byte{
					0x00, 0x00, 0x01, 0xb0,
					0x02, 0x00, 0x00, 0x01, 0xb5, 0x8a,
					0x14, 0x00, 0x00, 0x01, 0x00,
				}, formatMPEG4Video.Config)
			}
		})
	}
}

var casesDecodeEncode = []struct {
	name    string
	format  format.Format
	encoded []*rtp.Packet
	decoded unit.Payload
}{
	{
		name: "av1",
		format: &format.AV1{
			PayloadTyp: 96,
		},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         true,
					PayloadType:    96,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{
					0x10,
					0x02,       // Size = 2
					0x01, 0x02, // OBU data
				},
			},
		},
		decoded: unit.PayloadAV1{
			{0x02, 0x01, 0x02}, // Size byte included with OBU data
		},
	},
	{
		name: "vp9",
		format: &format.VP9{
			PayloadTyp: 96,
		},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         true,
					PayloadType:    96,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{
					0x8f, 0xb5, 0xaf, 0x18, 0x07, 0x80, 0x03, 0x24,
					0x01, 0x14, 0x01, 0x82, 0x49, 0x83, 0x42, 0x00,
					0x77, 0xf0, 0x32, 0x34,
				},
			},
		},
		decoded: unit.PayloadVP9{0x82, 0x49, 0x83, 0x42, 0x0, 0x77, 0xf0, 0x32, 0x34},
	},
	{
		name: "vp8",
		format: &format.VP8{
			PayloadTyp: 96,
		},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         true,
					PayloadType:    96,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{
					0x10, // X=0, R=0, N=0, S=1, PartID=0
					0x01, 0x02, 0x03, 0x04,
				},
			},
		},
		decoded: unit.PayloadVP8{0x01, 0x02, 0x03, 0x04},
	},
	{
		name: "h265",
		format: &format.H265{
			PayloadTyp: 96,
			VPS:        []byte{0x40, 0x01, 0x0c, 0x01, 0xff, 0xfe},
			SPS:        []byte{0x42, 0x01, 0x01, 0x01, 0x60, 0x00, 0x00, 0x04},
			PPS:        []byte{0x44, 0x01, 0xc1, 0x73, 0xd1, 0x8a},
		},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         true,
					PayloadType:    96,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{
					0x60, 0x01, 0x00, 0x06, 0x40, 0x01, 0x0c, 0x01,
					0xff, 0xfe, 0x00, 0x08, 0x42, 0x01, 0x01, 0x01,
					0x60, 0x00, 0x00, 0x04, 0x00, 0x06, 0x44, 0x01,
					0xc1, 0x73, 0xd1, 0x8a, 0x00, 0x05, 0x26, 0x01,
					0x01, 0x02, 0x03,
				},
			},
		},
		decoded: unit.PayloadH265{
			{0x40, 0x01, 0x0c, 0x01, 0xff, 0xfe},             // VPS
			{0x42, 0x01, 0x01, 0x01, 0x60, 0x00, 0x00, 0x04}, // SPS
			{0x44, 0x01, 0xc1, 0x73, 0xd1, 0x8a},             // PPS
			{0x26, 0x01, 0x01, 0x02, 0x03},                   // IDR
		},
	},
	{
		name: "h264",
		format: &format.H264{
			PayloadTyp: 96,
			SPS: []byte{
				0x67, 0x42, 0xc0, 0x28, 0xd9, 0x00, 0x78, 0x02,
				0x27, 0xe5, 0x84, 0x00, 0x00, 0x03, 0x00, 0x04,
				0x00, 0x00, 0x03, 0x00, 0xf0, 0x3c, 0x60, 0xc9, 0x20,
			},
			PPS: []byte{0x08, 0x06, 0x07, 0x08},
		},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         true,
					PayloadType:    96,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{
					0x18, 0x00, 0x19, 0x67, 0x42, 0xc0, 0x28, 0xd9,
					0x00, 0x78, 0x02, 0x27, 0xe5, 0x84, 0x00, 0x00,
					0x03, 0x00, 0x04, 0x00, 0x00, 0x03, 0x00, 0xf0,
					0x3c, 0x60, 0xc9, 0x20, 0x00, 0x04, 0x08, 0x06,
					0x07, 0x08, 0x00, 0x05, 0x05, 0x01, 0x02, 0x03,
					0x04,
				},
			},
		},
		decoded: unit.PayloadH264{
			{
				0x67, 0x42, 0xc0, 0x28, 0xd9, 0x00, 0x78, 0x02, 0x27, 0xe5, 0x84,
				0x00, 0x00, 0x03, 0x00, 0x04, 0x00, 0x00, 0x03, 0x00, 0xf0, 0x3c, 0x60, 0xc9, 0x20,
			}, // SPS
			{0x08, 0x06, 0x07, 0x08},       // PPS
			{0x05, 0x01, 0x02, 0x03, 0x04}, // IDR
		},
	},
	{
		name: "mpeg4video",
		format: &format.MPEG4Video{
			PayloadTyp: 96,
			Config:     []byte{0x00, 0x00, 0x01, 0xb0, 0x01},
		},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         true,
					PayloadType:    96,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{0x00, 0x01, 0x02, 0x03, 0x04},
			},
		},
		decoded: unit.PayloadMPEG4Video{0x00, 0x01, 0x02, 0x03, 0x04},
	},
	{
		name:   "mpeg1video",
		format: &format.MPEG1Video{},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         true, // Marker indicates complete frame
					PayloadType:    32,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{
					// MPEG-1 Video RTP header (4 bytes)
					0x00, // MBZ=0, T=0 (MPEG-1)
					0x00, // TR (temporal reference) - low 8 bits
					0x18, // AN=0, N=0, S=0 (no sequence header), B=1, E=1 (complete slice), FBV=0, BFC=0, FFV=0, FFC=0
					0x00, // FFC (continued)
					// MPEG-1 Video data (slice or frame data)
					0x00, 0x00, 0x01, 0x01, // Slice start code
					0x01, 0x02, 0x03, 0x04, // Slice data
				},
			},
		},
		decoded: unit.PayloadMPEG1Video{
			// Only the video data after the 4-byte RTP header
			0x00, 0x00, 0x01, 0x01,
			0x01, 0x02, 0x03, 0x04,
		},
	},
	{
		name:   "mjpeg",
		format: &format.MJPEG{},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:     2,
					PayloadType: 26,
				},
				Payload: []byte{
					0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xf0, 0x87,
					0x00, 0x00, 0x00, 0x80, 0x0d, 0x09, 0x0a, 0x0b,
					0x0a, 0x08, 0x0d, 0x0b, 0x0a, 0x0b, 0x0e, 0x0e,
					0x0d, 0x0f, 0x13, 0x20, 0x15, 0x13, 0x12, 0x12,
					0x13, 0x27, 0x1c, 0x1e, 0x17, 0x20, 0x2e, 0x29,
					0x31, 0x30, 0x2e, 0x29, 0x2d, 0x2c, 0x33, 0x3a,
					0x4a, 0x3e, 0x33, 0x36, 0x46, 0x37, 0x2c, 0x2d,
					0x40, 0x57, 0x41, 0x46, 0x4c, 0x4e, 0x52, 0x53,
					0x52, 0x32, 0x3e, 0x5a, 0x61, 0x5a, 0x50, 0x60,
					0x4a, 0x51, 0x52, 0x4f, 0x0e, 0x0e, 0x0e, 0x13,
					0x11, 0x13, 0x26, 0x15, 0x15, 0x26, 0x4f, 0x35,
					0x2d, 0x35, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f,
					0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f,
					0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f,
					0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f,
					0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f,
					0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f,
					0x4f, 0x4f, 0x4f, 0x4f, 0x92, 0x8a, 0x28, 0xaf,
					0x54, 0xf2, 0x42, 0x8a, 0x28, 0xa0, 0x02, 0x96,
					0x92, 0x96, 0x80, 0x0a, 0x4a, 0x75, 0x25, 0x02,
					0x12, 0x8a, 0x5a, 0x28, 0x18, 0x94, 0x52, 0xd1,
					0x40, 0x09, 0x45, 0x2d, 0x14, 0x08, 0x29, 0x69,
					0x29, 0x68, 0x00, 0xa5, 0xa4, 0xa5, 0xa0, 0x02,
					0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x04,
					0xa5, 0xa2, 0x8a, 0x00, 0x5a, 0x28, 0xa2, 0x80,
					0x0a, 0x28, 0xa2, 0x80, 0x0a, 0x28, 0xa2, 0x80,
					0x12, 0x8a, 0x5a, 0x28, 0x24, 0x29, 0x69, 0x29,
					0x68, 0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa2, 0x8a,
					0x28, 0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa2, 0x8a,
					0x28, 0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa2, 0x8a,
					0x28, 0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa2, 0x8a,
					0x28, 0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa2, 0x8a,
					0x28, 0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa4, 0xa5,
					0xa4, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a,
					0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a,
					0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a,
					0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a,
					0x28, 0xa0, 0x02, 0x96, 0x92, 0x96, 0x80, 0x0a,
					0x28, 0xa2, 0x80, 0x0a, 0x28, 0xa2, 0x80, 0x0a,
					0x28, 0xa2, 0x80, 0x0a, 0x28, 0xa2, 0x80, 0x0a,
					0x28, 0xa2, 0x80, 0x0a, 0x28, 0xa2, 0x80, 0x0a,
					0x28, 0xa2, 0x80, 0x0a, 0x28, 0xa2, 0x80, 0x0a,
					0x28, 0xa2, 0x81, 0x85, 0x14, 0x51, 0x40, 0x05,
					0x14, 0x51, 0x40, 0x05, 0x14, 0x51, 0x40, 0x05,
					0x14, 0x52, 0xd0, 0x01, 0x45, 0x14, 0x50, 0x01,
					0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01,
					0x45, 0x2d, 0x14, 0x00, 0x94, 0xb4, 0x51, 0x40,
					0x05, 0x14, 0x52, 0xd0, 0x02, 0x51, 0x4b, 0x45,
					0x00, 0x25, 0x2d, 0x14, 0x50, 0x01, 0x45, 0x14,
					0x50, 0x01, 0x45, 0x14, 0x50, 0x20, 0xa5, 0xa4,
					0xa5, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02, 0x8a,
					0x28, 0xa0, 0x02, 0x8a, 0x5a, 0x28, 0x18, 0x94,
					0xb4, 0x51, 0x40, 0xc2, 0x8a, 0x28, 0xa0, 0x05,
					0xa2, 0x92, 0x9d, 0x40, 0x05, 0x14, 0x51, 0x48,
					0x02, 0x8a, 0x28, 0xa4, 0x01, 0x4b, 0x49, 0x4b,
					0x40, 0x05, 0x14, 0x51, 0x40, 0x05, 0x14, 0xb4,
					0x50, 0x02, 0x51, 0x4b, 0x45, 0x00, 0x25, 0x2d,
					0x14, 0x50, 0x03, 0xa8, 0xa2, 0x8a, 0x00, 0x28,
					0xa2, 0x8a, 0x00, 0x5a, 0x29, 0x29, 0x68, 0x00,
					0xa2, 0x8a, 0x28, 0x00, 0xa2, 0x96, 0x8a, 0x06,
					0x25, 0x14, 0xb4, 0x50, 0x01, 0x45, 0x14, 0x50,
					0x02, 0xd2, 0xd2, 0x52, 0xd0, 0x20, 0xa2, 0x8a,
					0x28, 0x01, 0x68, 0xa2, 0x8a, 0x40, 0x14, 0x51,
					0x45, 0x30, 0x0a, 0x5a, 0x4a, 0x5a, 0x06, 0x14,
					0x51, 0x45, 0x02, 0x0a, 0x28, 0xa5, 0xa0, 0x62,
					0x51, 0x4b, 0x45, 0x00, 0x2d, 0x14, 0x51, 0x48,
					0x02, 0x8a, 0x28, 0xa0, 0x61, 0x45, 0x14, 0x50,
					0x03, 0xa8, 0xa2, 0x8a, 0x06, 0x2d, 0x14, 0x51,
					0x48, 0x02, 0x8a, 0x28, 0xa4, 0x30, 0xa2, 0x8a,
					0x2a, 0x80, 0x28, 0xa2, 0x8a, 0x00, 0x28, 0xa2,
					0x8a, 0x92, 0x45, 0xa5, 0xa2, 0x96, 0x82, 0x82,
					0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x05,
					0xa2, 0x8a, 0x29, 0x80, 0x52, 0xd2, 0x52, 0xd0,
					0x01, 0x45, 0x14, 0x50, 0x01, 0x4e, 0xa2, 0x8a,
					0x43, 0x0a, 0x28, 0xa2, 0x80, 0x0a, 0x28, 0xa4,
					0xa4, 0x31, 0x68, 0xa4, 0xf3, 0x62, 0xff, 0x00,
					0x9e, 0xd1, 0x7e, 0xea, 0x9f, 0xfe, 0xb6, 0xa4,
					0x62, 0x52, 0x53, 0xa9, 0x28, 0x01, 0x28, 0xa2,
					0x6f, 0xdd, 0x7f, 0xaf, 0xa5, 0xa0, 0x62, 0x51,
					0x4b, 0x45, 0x00, 0x25, 0x14, 0xbf, 0xba, 0xff,
					0x00, 0xae, 0xb4, 0xea, 0x60, 0x36, 0x9d, 0x49,
					0x49, 0x34, 0xb1, 0x45, 0xfe, 0xbe, 0x6f, 0x2a,
					0x98, 0x0f, 0xa2, 0xb9, 0xbd, 0x0f, 0x59, 0x97,
					0x54, 0xf1, 0x2d, 0xd7, 0xfc, 0xf9, 0xd7, 0x49,
					0x52, 0x30, 0xac, 0x7d, 0x5b, 0x54, 0xd5, 0x74,
					0xbf, 0xdf, 0x41, 0x67, 0x15, 0xd4, 0x35, 0x63,
					0x56, 0xd5, 0x22, 0xd2, 0xe0, 0xf3, 0xbc, 0x99,
					0x65, 0xae, 0x4b, 0x51, 0xf1, 0x44, 0x52, 0xff,
					0x00, 0xc7, 0x97, 0x9b, 0xe4, 0xd0, 0x69, 0x4c,
					0x76, 0xa3, 0xe2, 0xd9, 0xa5, 0x82, 0x29, 0xb4,
					0xbf, 0xdd, 0x79, 0xbf, 0xeb, 0x22, 0xaa, 0x7e,
					0x1e, 0xd5, 0x3e, 0xc1, 0x3f, 0xfa, 0x9f, 0xfa,
					0xe9, 0x25, 0x61, 0xd6, 0x9e, 0x87, 0xf6, 0xbf,
					0xed, 0x68, 0xbc, 0x8a, 0x82, 0xcf, 0x4e, 0x86,
					0x5f, 0x36, 0x0a, 0x92, 0x9b, 0xff, 0x00, 0x5d,
					0xeb, 0x3a, 0x6d, 0x53, 0xfd, 0x3f, 0xec, 0x76,
					0x3f, 0xbd, 0xff, 0x00, 0xa6, 0xbf, 0xc1, 0x54,
					0x66, 0x69, 0x51, 0x50, 0x4b, 0x2c, 0x51, 0x7e,
					0xe7, 0xce, 0xf3, 0x66, 0xff, 0x00, 0xa6, 0x75,
					0x35, 0x00, 0x2d, 0x65, 0x6a, 0xde, 0x23, 0xd3,
					0xec, 0x3f, 0xe5, 0xb7, 0x9b, 0x34, 0x5f, 0xf2,
					0xce, 0xb4, 0x7e, 0xd5, 0x69, 0x2f, 0xfc, 0xbe,
					0x45, 0x5e, 0x7b, 0xe2, 0x7d, 0x07, 0xec, 0x1e,
					0x6e, 0xa5, 0xf6, 0xc8, 0xa5, 0xf3, 0x6a, 0xc0,
					0xdf, 0xa2, 0x9d, 0x45, 0x6c, 0x72, 0x0d, 0xa5,
					0xa5, 0xa2, 0x80, 0x12, 0x96, 0x8a, 0x28, 0x10,
					0x51, 0x4b, 0x45, 0x00, 0x25, 0x14, 0xb4, 0x50,
					0x02, 0x51, 0x4b, 0x45, 0x03, 0x12, 0x8a, 0x5a,
					0x28, 0x10, 0x94, 0xb4, 0x51, 0x40, 0x05, 0x14,
					0x51, 0x40, 0x05, 0x14, 0xb4, 0x50, 0x02, 0x51,
					0x4b, 0x45, 0x00, 0x14, 0x51, 0x4b, 0x40, 0x84,
					0xa2, 0x8a, 0x28, 0x00, 0xa2, 0x96, 0x8a, 0x00,
					0x4a, 0x29, 0x68, 0xa0, 0x04, 0xa2, 0x96, 0x8a,
					0x00, 0x4a, 0x29, 0x68, 0xa0, 0x41, 0x45, 0x14,
					0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x14,
					0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x14,
					0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x14,
					0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x14,
					0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x14,
					0x50, 0x01, 0x49, 0x4b, 0x45, 0x00, 0x25, 0x14,
					0xb4, 0x50, 0x01, 0x45, 0x14, 0x50, 0x30, 0xa4,
					0xa5, 0xa2, 0x81, 0x09, 0x45, 0x2d, 0x14, 0x00,
					0x94, 0x52, 0xd1, 0x40, 0x09, 0x45, 0x2d, 0x14,
					0x00, 0x94, 0x52, 0xd1, 0x40, 0x05, 0x14, 0xb4,
					0x94, 0x0c, 0x28, 0xa2, 0x8a, 0x04, 0x14, 0x51,
					0x45, 0x00, 0x14, 0x51, 0x45, 0x00, 0x14, 0x51,
					0x45, 0x00, 0x14, 0x51, 0x45, 0x00, 0x14, 0x52,
					0xd1, 0x40, 0xc4, 0xa2, 0x96, 0x8a, 0x04, 0x25,
					0x14, 0xb4, 0x50, 0x31, 0x28, 0xa5, 0xa2, 0x80,
					0x12, 0x8a, 0x5a, 0x4a, 0x00, 0x5a, 0x28, 0xa2,
					0x80, 0x0a, 0x29, 0x68, 0xa0, 0x04, 0xa2, 0x96,
					0x8a, 0x00, 0x4a, 0x29, 0x68, 0xa0, 0x04, 0xa2,
					0x9d, 0x45, 0x03, 0x1b, 0x45, 0x3a, 0x8a, 0x00,
					0x6d, 0x14, 0xea, 0x28, 0x10, 0x94, 0x52, 0xd1,
					0x40, 0x09, 0x4b, 0x45, 0x14, 0x08, 0x28, 0xa2,
					0x8a, 0x06, 0x14, 0x52, 0xd1, 0x40, 0x09, 0x45,
					0x2d, 0x2d, 0x00, 0x25, 0x14, 0xb4, 0x50, 0x21,
					0x28, 0xa5, 0xa2, 0x81, 0x89, 0x4b, 0x45, 0x14,
					0x00, 0x51, 0x45, 0x14, 0x00, 0x51, 0x4b, 0x45,
					0x00, 0x25, 0x14, 0xb4, 0x50, 0x01, 0x45, 0x2d,
					0x14, 0x0c, 0x28, 0xa2, 0x8a, 0x00, 0x4a, 0x5a,
					0x5a, 0x28, 0x01, 0x28, 0xa5, 0xa2, 0x90, 0x05,
					0x14, 0x51, 0x40, 0x05, 0x14, 0xb4, 0x52, 0x01,
					0x28, 0xa5, 0xa2, 0x80, 0x0a, 0x28, 0xa7, 0x50,
					0x03, 0x68, 0xa7, 0x51, 0x40, 0x0d, 0xa7, 0x51,
					0x45, 0x00, 0x14, 0x51, 0x4b, 0x40, 0x09, 0x45,
					0x2d, 0x2d, 0x00, 0x25, 0x14, 0xb4, 0x50, 0x02,
					0x51, 0x4b, 0x45, 0x00, 0x14, 0x51, 0x45, 0x00,
					0x14, 0x51, 0x45, 0x00, 0x14, 0xb4, 0x53, 0xa8,
					0x18, 0xda, 0x5a, 0x5a, 0x28, 0x10, 0x94, 0xb4,
					0x51, 0x40, 0xc2, 0x8a, 0x5a, 0x29, 0x00, 0x94,
					0x52, 0xd1, 0x40, 0x05, 0x14, 0x51, 0x4c, 0x02,
					0x96, 0x8a, 0x29, 0x00, 0x52, 0xd2, 0x52, 0xd0,
					0x01, 0x45, 0x14, 0x50, 0x02, 0xd1, 0x45, 0x14,
					0x0c, 0x28, 0xa2, 0x96, 0x80, 0x0a, 0x28, 0xa2,
					0x81, 0x85, 0x2d, 0x14, 0x50, 0x01, 0x45, 0x14,
					0xb4, 0x80, 0x4a, 0x29, 0x68, 0xa0, 0x62, 0xd1,
					0x45, 0x14, 0xc0, 0x28, 0xa5, 0xa2, 0x90, 0x0d,
					0xa5, 0xa5, 0xa2, 0x80, 0x0a, 0x5a, 0x28, 0xa4,
					0x01, 0x45, 0x14, 0xb4, 0x00, 0x94, 0x52, 0xd1,
					0x40, 0x05, 0x14, 0x51, 0x4c, 0x02, 0x8a, 0x29,
					0x68, 0x01, 0x28, 0xa5, 0xa2, 0x80, 0x16, 0x8a,
					0x28, 0xa4, 0x30, 0xa7, 0x55, 0x7b, 0xbb, 0x5f,
					0xb7, 0xc1, 0xe4, 0xff, 0x00, 0xaa, 0xac, 0x49,
					0xb4, 0x6d, 0x57, 0x4b, 0xf3, 0x66, 0xd2, 0xef,
					0x3c, 0xd8, 0x69, 0x17, 0x4c, 0xe9, 0x2b, 0x07,
					0xc4, 0x32, 0xcb, 0x75, 0xa4, 0xff, 0x00, 0xc4,
					0xae, 0x68, 0xbf, 0x75, 0xfe, 0xb2, 0xb9, 0x09,
					0xb5, 0x9d, 0x42, 0x5f, 0x36, 0xcf, 0xce, 0xff,
					0x00, 0x5b, 0x56, 0x3c, 0x3d, 0x6b, 0xfd, 0xa9,
					0xab, 0x4b, 0x67, 0x3f, 0xfc, 0xf3, 0xff, 0x00,
					0x96, 0x74, 0x8d, 0xbd, 0x99, 0x9b, 0x0d, 0xfc,
					0xb2, 0xf9, 0xbf, 0xeb, 0x7f, 0x7b, 0x5a, 0xf0,
					0xf8, 0x8e, 0xee, 0x2d, 0x27, 0xec, 0x70, 0x7f,
					0xdf, 0xca, 0x66, 0xa3, 0xe1, 0x7f, 0xb0, 0x79,
					0xbe, 0x46, 0xa5, 0x17, 0xfd, 0x73, 0x92, 0xb0,
					0xe1, 0xa8, 0x0f, 0x66, 0x76, 0x90, 0xf8, 0xa2,
					0x29, 0x6c, 0x3c, 0x9f, 0xde, 0xf9, 0xde, 0x5f,
					0xef, 0x24, 0xaa, 0x76, 0x9e, 0x2d, 0xbb, 0x8b,
					0x49, 0xf2, 0x7f, 0xe5, 0xb5, 0x62, 0x5a, 0x5f,
					0xcb, 0x6b, 0xfe, 0xa3, 0xfe, 0x5a, 0xd1, 0xe5,
					0x45, 0xff,
				},
			},
			{
				Header: rtp.Header{
					Version:     2,
					PayloadType: 26,
					Marker:      true,
				},
				Payload: []byte{
					0x00, 0x00, 0x05, 0x1e, 0x01, 0xff, 0xf0, 0x87,
					0x00, 0x2c, 0x29, 0x0f, 0xd9, 0x97, 0xff, 0x00,
					0xb6, 0x65, 0xba, 0x82, 0x5f, 0xb7, 0x4d, 0xe6,
					0xcd, 0xff, 0x00, 0x2c, 0xe2, 0xae, 0xa7, 0x49,
					0xd5, 0x3f, 0xe2, 0x9a, 0xf3, 0xa7, 0xff, 0x00,
					0x5d, 0x15, 0x70, 0xb4, 0x43, 0xfb, 0xdf, 0xf5,
					0xf3, 0x4b, 0xff, 0x00, 0x5c, 0xe8, 0xf6, 0x83,
					0xf6, 0x67, 0xa1, 0x68, 0x7a, 0xcc, 0x5a, 0xcf,
					0xfd, 0x32, 0x9b, 0xfe, 0x79, 0xd5, 0xeb, 0xbb,
					0xab, 0x4b, 0x08, 0x3f, 0xd3, 0xab, 0xcd, 0x66,
					0xba, 0xfb, 0x57, 0xfd, 0x32, 0x9a, 0x2a, 0x96,
					0xd2, 0xff, 0x00, 0xcd, 0xbf, 0xf3, 0xb5, 0x49,
					0xbc, 0xdf, 0x2b, 0xfe, 0x59, 0xd3, 0x27, 0xd9,
					0x9a, 0x30, 0xdd, 0x7d, 0xab, 0x5e, 0xfb, 0x1d,
					0x8c, 0xde, 0x55, 0x9c, 0xb2, 0x79, 0x95, 0xd3,
					0x6a, 0x3a, 0xa7, 0xd9, 0x75, 0xdb, 0x5b, 0x39,
					0xff, 0x00, 0xd4, 0xcb, 0xff, 0x00, 0x2d, 0x2b,
					0xcf, 0xbe, 0xdf, 0xe5, 0x6a, 0xdf, 0x6c, 0x83,
					0xfe, 0x59, 0x54, 0xda, 0xb6, 0xb3, 0x2e, 0xb3,
					0x7f, 0xe7, 0x7f, 0xaa, 0xff, 0xff, 0xd9,
				},
			},
		},
		decoded: unit.PayloadMJPEG{
			0xff, 0xd8, 0xff, 0xdb, 0x00, 0x84, 0x00, 0x0d,
			0x09, 0x0a, 0x0b, 0x0a, 0x08, 0x0d, 0x0b, 0x0a,
			0x0b, 0x0e, 0x0e, 0x0d, 0x0f, 0x13, 0x20, 0x15,
			0x13, 0x12, 0x12, 0x13, 0x27, 0x1c, 0x1e, 0x17,
			0x20, 0x2e, 0x29, 0x31, 0x30, 0x2e, 0x29, 0x2d,
			0x2c, 0x33, 0x3a, 0x4a, 0x3e, 0x33, 0x36, 0x46,
			0x37, 0x2c, 0x2d, 0x40, 0x57, 0x41, 0x46, 0x4c,
			0x4e, 0x52, 0x53, 0x52, 0x32, 0x3e, 0x5a, 0x61,
			0x5a, 0x50, 0x60, 0x4a, 0x51, 0x52, 0x4f, 0x01,
			0x0e, 0x0e, 0x0e, 0x13, 0x11, 0x13, 0x26, 0x15,
			0x15, 0x26, 0x4f, 0x35, 0x2d, 0x35, 0x4f, 0x4f,
			0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f,
			0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f,
			0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f,
			0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f,
			0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f,
			0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f, 0x4f,
			0xff, 0xc0, 0x00, 0x11, 0x08, 0x04, 0x38, 0x07,
			0x80, 0x03, 0x00, 0x22, 0x00, 0x01, 0x11, 0x01,
			0x02, 0x11, 0x01, 0xff, 0xc4, 0x00, 0x1f, 0x00,
			0x00, 0x01, 0x05, 0x01, 0x01, 0x01, 0x01, 0x01,
			0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
			0x08, 0x09, 0x0a, 0x0b, 0xff, 0xc4, 0x00, 0xb5,
			0x10, 0x00, 0x02, 0x01, 0x03, 0x03, 0x02, 0x04,
			0x03, 0x05, 0x05, 0x04, 0x04, 0x00, 0x00, 0x01,
			0x7d, 0x01, 0x02, 0x03, 0x00, 0x04, 0x11, 0x05,
			0x12, 0x21, 0x31, 0x41, 0x06, 0x13, 0x51, 0x61,
			0x07, 0x22, 0x71, 0x14, 0x32, 0x81, 0x91, 0xa1,
			0x08, 0x23, 0x42, 0xb1, 0xc1, 0x15, 0x52, 0xd1,
			0xf0, 0x24, 0x33, 0x62, 0x72, 0x82, 0x09, 0x0a,
			0x16, 0x17, 0x18, 0x19, 0x1a, 0x25, 0x26, 0x27,
			0x28, 0x29, 0x2a, 0x34, 0x35, 0x36, 0x37, 0x38,
			0x39, 0x3a, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,
			0x49, 0x4a, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58,
			0x59, 0x5a, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68,
			0x69, 0x6a, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78,
			0x79, 0x7a, 0x83, 0x84, 0x85, 0x86, 0x87, 0x88,
			0x89, 0x8a, 0x92, 0x93, 0x94, 0x95, 0x96, 0x97,
			0x98, 0x99, 0x9a, 0xa2, 0xa3, 0xa4, 0xa5, 0xa6,
			0xa7, 0xa8, 0xa9, 0xaa, 0xb2, 0xb3, 0xb4, 0xb5,
			0xb6, 0xb7, 0xb8, 0xb9, 0xba, 0xc2, 0xc3, 0xc4,
			0xc5, 0xc6, 0xc7, 0xc8, 0xc9, 0xca, 0xd2, 0xd3,
			0xd4, 0xd5, 0xd6, 0xd7, 0xd8, 0xd9, 0xda, 0xe1,
			0xe2, 0xe3, 0xe4, 0xe5, 0xe6, 0xe7, 0xe8, 0xe9,
			0xea, 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7,
			0xf8, 0xf9, 0xfa, 0xff, 0xc4, 0x00, 0x1f, 0x01,
			0x00, 0x03, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
			0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
			0x08, 0x09, 0x0a, 0x0b, 0xff, 0xc4, 0x00, 0xb5,
			0x11, 0x00, 0x02, 0x01, 0x02, 0x04, 0x04, 0x03,
			0x04, 0x07, 0x05, 0x04, 0x04, 0x00, 0x01, 0x02,
			0x77, 0x00, 0x01, 0x02, 0x03, 0x11, 0x04, 0x05,
			0x21, 0x31, 0x06, 0x12, 0x41, 0x51, 0x07, 0x61,
			0x71, 0x13, 0x22, 0x32, 0x81, 0x08, 0x14, 0x42,
			0x91, 0xa1, 0xb1, 0xc1, 0x09, 0x23, 0x33, 0x52,
			0xf0, 0x15, 0x62, 0x72, 0xd1, 0x0a, 0x16, 0x24,
			0x34, 0xe1, 0x25, 0xf1, 0x17, 0x18, 0x19, 0x1a,
			0x26, 0x27, 0x28, 0x29, 0x2a, 0x35, 0x36, 0x37,
			0x38, 0x39, 0x3a, 0x43, 0x44, 0x45, 0x46, 0x47,
			0x48, 0x49, 0x4a, 0x53, 0x54, 0x55, 0x56, 0x57,
			0x58, 0x59, 0x5a, 0x63, 0x64, 0x65, 0x66, 0x67,
			0x68, 0x69, 0x6a, 0x73, 0x74, 0x75, 0x76, 0x77,
			0x78, 0x79, 0x7a, 0x82, 0x83, 0x84, 0x85, 0x86,
			0x87, 0x88, 0x89, 0x8a, 0x92, 0x93, 0x94, 0x95,
			0x96, 0x97, 0x98, 0x99, 0x9a, 0xa2, 0xa3, 0xa4,
			0xa5, 0xa6, 0xa7, 0xa8, 0xa9, 0xaa, 0xb2, 0xb3,
			0xb4, 0xb5, 0xb6, 0xb7, 0xb8, 0xb9, 0xba, 0xc2,
			0xc3, 0xc4, 0xc5, 0xc6, 0xc7, 0xc8, 0xc9, 0xca,
			0xd2, 0xd3, 0xd4, 0xd5, 0xd6, 0xd7, 0xd8, 0xd9,
			0xda, 0xe2, 0xe3, 0xe4, 0xe5, 0xe6, 0xe7, 0xe8,
			0xe9, 0xea, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7,
			0xf8, 0xf9, 0xfa, 0xff, 0xda, 0x00, 0x0c, 0x03,
			0x00, 0x00, 0x01, 0x11, 0x02, 0x11, 0x00, 0x3f,
			0x00, 0x92, 0x8a, 0x28, 0xaf, 0x54, 0xf2, 0x42,
			0x8a, 0x28, 0xa0, 0x02, 0x96, 0x92, 0x96, 0x80,
			0x0a, 0x4a, 0x75, 0x25, 0x02, 0x12, 0x8a, 0x5a,
			0x28, 0x18, 0x94, 0x52, 0xd1, 0x40, 0x09, 0x45,
			0x2d, 0x14, 0x08, 0x29, 0x69, 0x29, 0x68, 0x00,
			0xa5, 0xa4, 0xa5, 0xa0, 0x02, 0x8a, 0x28, 0xa0,
			0x02, 0x8a, 0x28, 0xa0, 0x04, 0xa5, 0xa2, 0x8a,
			0x00, 0x5a, 0x28, 0xa2, 0x80, 0x0a, 0x28, 0xa2,
			0x80, 0x0a, 0x28, 0xa2, 0x80, 0x12, 0x8a, 0x5a,
			0x28, 0x24, 0x29, 0x69, 0x29, 0x68, 0x00, 0xa2,
			0x8a, 0x28, 0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa2,
			0x8a, 0x28, 0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa2,
			0x8a, 0x28, 0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa2,
			0x8a, 0x28, 0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa2,
			0x8a, 0x28, 0x00, 0xa2, 0x8a, 0x28, 0x00, 0xa2,
			0x8a, 0x28, 0x00, 0xa4, 0xa5, 0xa4, 0xa0, 0x02,
			0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02,
			0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02,
			0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02,
			0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02,
			0x96, 0x92, 0x96, 0x80, 0x0a, 0x28, 0xa2, 0x80,
			0x0a, 0x28, 0xa2, 0x80, 0x0a, 0x28, 0xa2, 0x80,
			0x0a, 0x28, 0xa2, 0x80, 0x0a, 0x28, 0xa2, 0x80,
			0x0a, 0x28, 0xa2, 0x80, 0x0a, 0x28, 0xa2, 0x80,
			0x0a, 0x28, 0xa2, 0x80, 0x0a, 0x28, 0xa2, 0x81,
			0x85, 0x14, 0x51, 0x40, 0x05, 0x14, 0x51, 0x40,
			0x05, 0x14, 0x51, 0x40, 0x05, 0x14, 0x52, 0xd0,
			0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x14, 0x50,
			0x01, 0x45, 0x14, 0x50, 0x01, 0x45, 0x2d, 0x14,
			0x00, 0x94, 0xb4, 0x51, 0x40, 0x05, 0x14, 0x52,
			0xd0, 0x02, 0x51, 0x4b, 0x45, 0x00, 0x25, 0x2d,
			0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45,
			0x14, 0x50, 0x20, 0xa5, 0xa4, 0xa5, 0xa0, 0x02,
			0x8a, 0x28, 0xa0, 0x02, 0x8a, 0x28, 0xa0, 0x02,
			0x8a, 0x5a, 0x28, 0x18, 0x94, 0xb4, 0x51, 0x40,
			0xc2, 0x8a, 0x28, 0xa0, 0x05, 0xa2, 0x92, 0x9d,
			0x40, 0x05, 0x14, 0x51, 0x48, 0x02, 0x8a, 0x28,
			0xa4, 0x01, 0x4b, 0x49, 0x4b, 0x40, 0x05, 0x14,
			0x51, 0x40, 0x05, 0x14, 0xb4, 0x50, 0x02, 0x51,
			0x4b, 0x45, 0x00, 0x25, 0x2d, 0x14, 0x50, 0x03,
			0xa8, 0xa2, 0x8a, 0x00, 0x28, 0xa2, 0x8a, 0x00,
			0x5a, 0x29, 0x29, 0x68, 0x00, 0xa2, 0x8a, 0x28,
			0x00, 0xa2, 0x96, 0x8a, 0x06, 0x25, 0x14, 0xb4,
			0x50, 0x01, 0x45, 0x14, 0x50, 0x02, 0xd2, 0xd2,
			0x52, 0xd0, 0x20, 0xa2, 0x8a, 0x28, 0x01, 0x68,
			0xa2, 0x8a, 0x40, 0x14, 0x51, 0x45, 0x30, 0x0a,
			0x5a, 0x4a, 0x5a, 0x06, 0x14, 0x51, 0x45, 0x02,
			0x0a, 0x28, 0xa5, 0xa0, 0x62, 0x51, 0x4b, 0x45,
			0x00, 0x2d, 0x14, 0x51, 0x48, 0x02, 0x8a, 0x28,
			0xa0, 0x61, 0x45, 0x14, 0x50, 0x03, 0xa8, 0xa2,
			0x8a, 0x06, 0x2d, 0x14, 0x51, 0x48, 0x02, 0x8a,
			0x28, 0xa4, 0x30, 0xa2, 0x8a, 0x2a, 0x80, 0x28,
			0xa2, 0x8a, 0x00, 0x28, 0xa2, 0x8a, 0x92, 0x45,
			0xa5, 0xa2, 0x96, 0x82, 0x82, 0x8a, 0x28, 0xa0,
			0x02, 0x8a, 0x28, 0xa0, 0x05, 0xa2, 0x8a, 0x29,
			0x80, 0x52, 0xd2, 0x52, 0xd0, 0x01, 0x45, 0x14,
			0x50, 0x01, 0x4e, 0xa2, 0x8a, 0x43, 0x0a, 0x28,
			0xa2, 0x80, 0x0a, 0x28, 0xa4, 0xa4, 0x31, 0x68,
			0xa4, 0xf3, 0x62, 0xff, 0x00, 0x9e, 0xd1, 0x7e,
			0xea, 0x9f, 0xfe, 0xb6, 0xa4, 0x62, 0x52, 0x53,
			0xa9, 0x28, 0x01, 0x28, 0xa2, 0x6f, 0xdd, 0x7f,
			0xaf, 0xa5, 0xa0, 0x62, 0x51, 0x4b, 0x45, 0x00,
			0x25, 0x14, 0xbf, 0xba, 0xff, 0x00, 0xae, 0xb4,
			0xea, 0x60, 0x36, 0x9d, 0x49, 0x49, 0x34, 0xb1,
			0x45, 0xfe, 0xbe, 0x6f, 0x2a, 0x98, 0x0f, 0xa2,
			0xb9, 0xbd, 0x0f, 0x59, 0x97, 0x54, 0xf1, 0x2d,
			0xd7, 0xfc, 0xf9, 0xd7, 0x49, 0x52, 0x30, 0xac,
			0x7d, 0x5b, 0x54, 0xd5, 0x74, 0xbf, 0xdf, 0x41,
			0x67, 0x15, 0xd4, 0x35, 0x63, 0x56, 0xd5, 0x22,
			0xd2, 0xe0, 0xf3, 0xbc, 0x99, 0x65, 0xae, 0x4b,
			0x51, 0xf1, 0x44, 0x52, 0xff, 0x00, 0xc7, 0x97,
			0x9b, 0xe4, 0xd0, 0x69, 0x4c, 0x76, 0xa3, 0xe2,
			0xd9, 0xa5, 0x82, 0x29, 0xb4, 0xbf, 0xdd, 0x79,
			0xbf, 0xeb, 0x22, 0xaa, 0x7e, 0x1e, 0xd5, 0x3e,
			0xc1, 0x3f, 0xfa, 0x9f, 0xfa, 0xe9, 0x25, 0x61,
			0xd6, 0x9e, 0x87, 0xf6, 0xbf, 0xed, 0x68, 0xbc,
			0x8a, 0x82, 0xcf, 0x4e, 0x86, 0x5f, 0x36, 0x0a,
			0x92, 0x9b, 0xff, 0x00, 0x5d, 0xeb, 0x3a, 0x6d,
			0x53, 0xfd, 0x3f, 0xec, 0x76, 0x3f, 0xbd, 0xff,
			0x00, 0xa6, 0xbf, 0xc1, 0x54, 0x66, 0x69, 0x51,
			0x50, 0x4b, 0x2c, 0x51, 0x7e, 0xe7, 0xce, 0xf3,
			0x66, 0xff, 0x00, 0xa6, 0x75, 0x35, 0x00, 0x2d,
			0x65, 0x6a, 0xde, 0x23, 0xd3, 0xec, 0x3f, 0xe5,
			0xb7, 0x9b, 0x34, 0x5f, 0xf2, 0xce, 0xb4, 0x7e,
			0xd5, 0x69, 0x2f, 0xfc, 0xbe, 0x45, 0x5e, 0x7b,
			0xe2, 0x7d, 0x07, 0xec, 0x1e, 0x6e, 0xa5, 0xf6,
			0xc8, 0xa5, 0xf3, 0x6a, 0xc0, 0xdf, 0xa2, 0x9d,
			0x45, 0x6c, 0x72, 0x0d, 0xa5, 0xa5, 0xa2, 0x80,
			0x12, 0x96, 0x8a, 0x28, 0x10, 0x51, 0x4b, 0x45,
			0x00, 0x25, 0x14, 0xb4, 0x50, 0x02, 0x51, 0x4b,
			0x45, 0x03, 0x12, 0x8a, 0x5a, 0x28, 0x10, 0x94,
			0xb4, 0x51, 0x40, 0x05, 0x14, 0x51, 0x40, 0x05,
			0x14, 0xb4, 0x50, 0x02, 0x51, 0x4b, 0x45, 0x00,
			0x14, 0x51, 0x4b, 0x40, 0x84, 0xa2, 0x8a, 0x28,
			0x00, 0xa2, 0x96, 0x8a, 0x00, 0x4a, 0x29, 0x68,
			0xa0, 0x04, 0xa2, 0x96, 0x8a, 0x00, 0x4a, 0x29,
			0x68, 0xa0, 0x41, 0x45, 0x14, 0x50, 0x01, 0x45,
			0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45,
			0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45,
			0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45,
			0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x45,
			0x14, 0x50, 0x01, 0x45, 0x14, 0x50, 0x01, 0x49,
			0x4b, 0x45, 0x00, 0x25, 0x14, 0xb4, 0x50, 0x01,
			0x45, 0x14, 0x50, 0x30, 0xa4, 0xa5, 0xa2, 0x81,
			0x09, 0x45, 0x2d, 0x14, 0x00, 0x94, 0x52, 0xd1,
			0x40, 0x09, 0x45, 0x2d, 0x14, 0x00, 0x94, 0x52,
			0xd1, 0x40, 0x05, 0x14, 0xb4, 0x94, 0x0c, 0x28,
			0xa2, 0x8a, 0x04, 0x14, 0x51, 0x45, 0x00, 0x14,
			0x51, 0x45, 0x00, 0x14, 0x51, 0x45, 0x00, 0x14,
			0x51, 0x45, 0x00, 0x14, 0x52, 0xd1, 0x40, 0xc4,
			0xa2, 0x96, 0x8a, 0x04, 0x25, 0x14, 0xb4, 0x50,
			0x31, 0x28, 0xa5, 0xa2, 0x80, 0x12, 0x8a, 0x5a,
			0x4a, 0x00, 0x5a, 0x28, 0xa2, 0x80, 0x0a, 0x29,
			0x68, 0xa0, 0x04, 0xa2, 0x96, 0x8a, 0x00, 0x4a,
			0x29, 0x68, 0xa0, 0x04, 0xa2, 0x9d, 0x45, 0x03,
			0x1b, 0x45, 0x3a, 0x8a, 0x00, 0x6d, 0x14, 0xea,
			0x28, 0x10, 0x94, 0x52, 0xd1, 0x40, 0x09, 0x4b,
			0x45, 0x14, 0x08, 0x28, 0xa2, 0x8a, 0x06, 0x14,
			0x52, 0xd1, 0x40, 0x09, 0x45, 0x2d, 0x2d, 0x00,
			0x25, 0x14, 0xb4, 0x50, 0x21, 0x28, 0xa5, 0xa2,
			0x81, 0x89, 0x4b, 0x45, 0x14, 0x00, 0x51, 0x45,
			0x14, 0x00, 0x51, 0x4b, 0x45, 0x00, 0x25, 0x14,
			0xb4, 0x50, 0x01, 0x45, 0x2d, 0x14, 0x0c, 0x28,
			0xa2, 0x8a, 0x00, 0x4a, 0x5a, 0x5a, 0x28, 0x01,
			0x28, 0xa5, 0xa2, 0x90, 0x05, 0x14, 0x51, 0x40,
			0x05, 0x14, 0xb4, 0x52, 0x01, 0x28, 0xa5, 0xa2,
			0x80, 0x0a, 0x28, 0xa7, 0x50, 0x03, 0x68, 0xa7,
			0x51, 0x40, 0x0d, 0xa7, 0x51, 0x45, 0x00, 0x14,
			0x51, 0x4b, 0x40, 0x09, 0x45, 0x2d, 0x2d, 0x00,
			0x25, 0x14, 0xb4, 0x50, 0x02, 0x51, 0x4b, 0x45,
			0x00, 0x14, 0x51, 0x45, 0x00, 0x14, 0x51, 0x45,
			0x00, 0x14, 0xb4, 0x53, 0xa8, 0x18, 0xda, 0x5a,
			0x5a, 0x28, 0x10, 0x94, 0xb4, 0x51, 0x40, 0xc2,
			0x8a, 0x5a, 0x29, 0x00, 0x94, 0x52, 0xd1, 0x40,
			0x05, 0x14, 0x51, 0x4c, 0x02, 0x96, 0x8a, 0x29,
			0x00, 0x52, 0xd2, 0x52, 0xd0, 0x01, 0x45, 0x14,
			0x50, 0x02, 0xd1, 0x45, 0x14, 0x0c, 0x28, 0xa2,
			0x96, 0x80, 0x0a, 0x28, 0xa2, 0x81, 0x85, 0x2d,
			0x14, 0x50, 0x01, 0x45, 0x14, 0xb4, 0x80, 0x4a,
			0x29, 0x68, 0xa0, 0x62, 0xd1, 0x45, 0x14, 0xc0,
			0x28, 0xa5, 0xa2, 0x90, 0x0d, 0xa5, 0xa5, 0xa2,
			0x80, 0x0a, 0x5a, 0x28, 0xa4, 0x01, 0x45, 0x14,
			0xb4, 0x00, 0x94, 0x52, 0xd1, 0x40, 0x05, 0x14,
			0x51, 0x4c, 0x02, 0x8a, 0x29, 0x68, 0x01, 0x28,
			0xa5, 0xa2, 0x80, 0x16, 0x8a, 0x28, 0xa4, 0x30,
			0xa7, 0x55, 0x7b, 0xbb, 0x5f, 0xb7, 0xc1, 0xe4,
			0xff, 0x00, 0xaa, 0xac, 0x49, 0xb4, 0x6d, 0x57,
			0x4b, 0xf3, 0x66, 0xd2, 0xef, 0x3c, 0xd8, 0x69,
			0x17, 0x4c, 0xe9, 0x2b, 0x07, 0xc4, 0x32, 0xcb,
			0x75, 0xa4, 0xff, 0x00, 0xc4, 0xae, 0x68, 0xbf,
			0x75, 0xfe, 0xb2, 0xb9, 0x09, 0xb5, 0x9d, 0x42,
			0x5f, 0x36, 0xcf, 0xce, 0xff, 0x00, 0x5b, 0x56,
			0x3c, 0x3d, 0x6b, 0xfd, 0xa9, 0xab, 0x4b, 0x67,
			0x3f, 0xfc, 0xf3, 0xff, 0x00, 0x96, 0x74, 0x8d,
			0xbd, 0x99, 0x9b, 0x0d, 0xfc, 0xb2, 0xf9, 0xbf,
			0xeb, 0x7f, 0x7b, 0x5a, 0xf0, 0xf8, 0x8e, 0xee,
			0x2d, 0x27, 0xec, 0x70, 0x7f, 0xdf, 0xca, 0x66,
			0xa3, 0xe1, 0x7f, 0xb0, 0x79, 0xbe, 0x46, 0xa5,
			0x17, 0xfd, 0x73, 0x92, 0xb0, 0xe1, 0xa8, 0x0f,
			0x66, 0x76, 0x90, 0xf8, 0xa2, 0x29, 0x6c, 0x3c,
			0x9f, 0xde, 0xf9, 0xde, 0x5f, 0xef, 0x24, 0xaa,
			0x76, 0x9e, 0x2d, 0xbb, 0x8b, 0x49, 0xf2, 0x7f,
			0xe5, 0xb5, 0x62, 0x5a, 0x5f, 0xcb, 0x6b, 0xfe,
			0xa3, 0xfe, 0x5a, 0xd1, 0xe5, 0x45, 0xff, 0x00,
			0x2c, 0x29, 0x0f, 0xd9, 0x97, 0xff, 0x00, 0xb6,
			0x65, 0xba, 0x82, 0x5f, 0xb7, 0x4d, 0xe6, 0xcd,
			0xff, 0x00, 0x2c, 0xe2, 0xae, 0xa7, 0x49, 0xd5,
			0x3f, 0xe2, 0x9a, 0xf3, 0xa7, 0xff, 0x00, 0x5d,
			0x15, 0x70, 0xb4, 0x43, 0xfb, 0xdf, 0xf5, 0xf3,
			0x4b, 0xff, 0x00, 0x5c, 0xe8, 0xf6, 0x83, 0xf6,
			0x67, 0xa1, 0x68, 0x7a, 0xcc, 0x5a, 0xcf, 0xfd,
			0x32, 0x9b, 0xfe, 0x79, 0xd5, 0xeb, 0xbb, 0xab,
			0x4b, 0x08, 0x3f, 0xd3, 0xab, 0xcd, 0x66, 0xba,
			0xfb, 0x57, 0xfd, 0x32, 0x9a, 0x2a, 0x96, 0xd2,
			0xff, 0x00, 0xcd, 0xbf, 0xf3, 0xb5, 0x49, 0xbc,
			0xdf, 0x2b, 0xfe, 0x59, 0xd3, 0x27, 0xd9, 0x9a,
			0x30, 0xdd, 0x7d, 0xab, 0x5e, 0xfb, 0x1d, 0x8c,
			0xde, 0x55, 0x9c, 0xb2, 0x79, 0x95, 0xd3, 0x6a,
			0x3a, 0xa7, 0xd9, 0x75, 0xdb, 0x5b, 0x39, 0xff,
			0x00, 0xd4, 0xcb, 0xff, 0x00, 0x2d, 0x2b, 0xcf,
			0xbe, 0xdf, 0xe5, 0x6a, 0xdf, 0x6c, 0x83, 0xfe,
			0x59, 0x54, 0xda, 0xb6, 0xb3, 0x2e, 0xb3, 0x7f,
			0xe7, 0x7f, 0xaa, 0xff, 0xff, 0xd9,
		},
	},
	{
		name: "mpeg4audio",
		format: &format.MPEG4Audio{
			PayloadTyp:       96,
			SizeLength:       13,
			IndexLength:      3,
			IndexDeltaLength: 3,
		},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         true,
					PayloadType:    96,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{
					// AU-headers-length: 16 bits (2 bytes) = 16 bits of headers
					0x00, 0x10,
					// AU-header: 13 bits size + 3 bits index
					// size=4 (13 bits): 0000000000100
					// index=0 (3 bits): 000
					// Combined: 0000000000100000 = 0x0020
					0x00, 0x20,
					// AU data
					0x01, 0x02, 0x03, 0x04,
				},
			},
		},
		decoded: unit.PayloadMPEG4Audio{
			{0x01, 0x02, 0x03, 0x04},
		},
	},
	{
		name: "opus",
		format: &format.Opus{
			PayloadTyp:   96,
			ChannelCount: 2,
		},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         false,
					PayloadType:    96,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{0x01, 0x02, 0x03, 0x04},
			},
		},
		decoded: unit.PayloadOpus{
			{0x01, 0x02, 0x03, 0x04},
		},
	},
	{
		name: "g711",
		format: &format.G711{
			MULaw:        true,
			SampleRate:   8000,
			ChannelCount: 1,
		},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         false,
					PayloadType:    0,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{0x01, 0x02, 0x03, 0x04},
			},
		},
		decoded: unit.PayloadG711{0x01, 0x02, 0x03, 0x04},
	},
	{
		name: "lpcm",
		format: &format.LPCM{
			PayloadTyp:   96,
			BitDepth:     16,
			SampleRate:   48000,
			ChannelCount: 2,
		},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         false,
					PayloadType:    96,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{0x01, 0x02, 0x03, 0x04},
			},
		},
		decoded: unit.PayloadLPCM{0x01, 0x02, 0x03, 0x04},
	},
	{
		name: "klv",
		format: &format.KLV{
			PayloadTyp: 96,
		},
		encoded: []*rtp.Packet{
			{
				Header: rtp.Header{
					Version:        2,
					Marker:         true, // Marker bit indicates complete KLV unit
					PayloadType:    96,
					SequenceNumber: 123,
					Timestamp:      45343,
					SSRC:           563423,
				},
				Payload: []byte{
					// KLV Universal Label Key (16 bytes) - starts with 0x060e2b34
					0x06, 0x0e, 0x2b, 0x34, 0x01, 0x01, 0x01, 0x01,
					0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
					// Length (1 byte, short form: 4 bytes of data)
					0x04,
					// Value (4 bytes)
					0x01, 0x02, 0x03, 0x04,
				},
			},
		},
		decoded: unit.PayloadKLV{
			// Complete KLV unit: Universal Label Key + Length + Value
			0x06, 0x0e, 0x2b, 0x34, 0x01, 0x01, 0x01, 0x01,
			0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
			0x04,
			0x01, 0x02, 0x03, 0x04,
		},
	},
}

func TestStreamDecode(t *testing.T) {
	for _, ca := range casesDecodeEncode {
		t.Run(ca.name, func(t *testing.T) {
			desc := &description.Session{Medias: []*description.Media{{
				Formats: []format.Format{ca.format},
			}}}

			strm := &Stream{
				Desc:              desc,
				WriteQueueSize:    512,
				RTPMaxPayloadSize: 1450,
				Parent:            &nilLogger{},
			}
			err := strm.Initialize()
			require.NoError(t, err)
			defer strm.Close()

			subStream := &SubStream{
				Stream:        strm,
				UseRTPPackets: true,
			}
			err = subStream.Initialize()
			require.NoError(t, err)

			r := &Reader{}
			recv := make(chan *unit.Unit)

			r.OnData(desc.Medias[0], ca.format, func(u *unit.Unit) error {
				if !u.NilPayload() {
					recv <- u
					close(recv)
				}
				return nil
			})

			strm.AddReader(r)
			defer strm.RemoveReader(r)

			for _, pkt := range ca.encoded {
				subStream.WriteUnit(desc.Medias[0], ca.format, &unit.Unit{
					RTPPackets: []*rtp.Packet{pkt},
				})
			}

			received := <-recv
			require.Equal(t, ca.decoded, received.Payload)
		})
	}
}

func TestStreamEncode(t *testing.T) {
	for _, ca := range casesDecodeEncode {
		t.Run(ca.name, func(t *testing.T) {
			desc := &description.Session{Medias: []*description.Media{{
				Formats: []format.Format{ca.format},
			}}}

			strm := &Stream{
				Desc:              desc,
				WriteQueueSize:    512,
				RTPMaxPayloadSize: 1450,
				Parent:            &nilLogger{},
			}
			err := strm.Initialize()
			require.NoError(t, err)
			defer strm.Close()

			subStream := &SubStream{
				Stream:        strm,
				UseRTPPackets: false,
			}
			err = subStream.Initialize()
			require.NoError(t, err)

			r := &Reader{}
			recv := make(chan struct{})

			r.OnData(desc.Medias[0], ca.format, func(u *unit.Unit) error {
				for i := range min(len(u.RTPPackets), len(ca.encoded)) {
					u.RTPPackets[i].Timestamp = ca.encoded[i].Timestamp
					u.RTPPackets[i].SequenceNumber = ca.encoded[i].SequenceNumber
					u.RTPPackets[i].SSRC = ca.encoded[i].SSRC
				}
				require.Equal(t, ca.encoded, u.RTPPackets)
				close(recv)
				return nil
			})

			strm.AddReader(r)
			defer strm.RemoveReader(r)

			subStream.WriteUnit(desc.Medias[0], ca.format, &unit.Unit{
				Payload: ca.decoded,
			})

			<-recv
		})
	}
}

func TestStreamAlwaysAvailable(t *testing.T) {
	strm := &Stream{
		AlwaysAvailable: true,
		AlwaysAvailableTracks: []conf.AlwaysAvailableTrack{
			{Codec: conf.CodecH264},
			{Codec: conf.CodecOpus, SampleRate: 48000, ChannelCount: 2},
		},
		WriteQueueSize:    512,
		RTPMaxPayloadSize: 1450,
		ReplaceNTP:        true,
		Parent:            &nilLogger{},
	}
	err := strm.Initialize()
	require.NoError(t, err)
	defer strm.Close()

	r := &Reader{
		Parent: &nilLogger{},
	}

	recv1 := make(chan struct{})
	recv2 := make(chan struct{})
	var lastPTS int64

	r.OnData(strm.Desc.Medias[0], strm.Desc.Medias[0].Formats[0], func(u *unit.Unit) error {
		require.GreaterOrEqual(t, u.PTS, lastPTS)
		lastPTS = u.PTS

		select {
		case <-recv1:
		default:
			close(recv1)
		}

		if len(u.Payload.(unit.PayloadH264)) == 3 && bytes.Equal(u.Payload.(unit.PayloadH264)[2], []byte{5, 2}) {
			close(recv2)
		}

		return nil
	})

	strm.AddReader(r)
	defer strm.RemoveReader(r)

	<-recv1

	desc := &description.Session{Medias: []*description.Media{
		{
			Type:    description.MediaTypeVideo,
			Formats: []format.Format{&format.H264{}},
		},
		{
			Type:    description.MediaTypeAudio,
			Formats: []format.Format{&format.Opus{}},
		},
	}}

	subStream := &SubStream{
		Stream:        strm,
		CurDesc:       desc,
		UseRTPPackets: false,
	}
	err = subStream.Initialize()
	require.NoError(t, err)

	subStream.WriteUnit(desc.Medias[0], desc.Medias[0].Formats[0], &unit.Unit{
		PTS: 90000,
		Payload: unit.PayloadH264{
			{5, 2}, // IDR
		},
	})

	<-recv2
}

func TestStreamAlwaysAvailableErrors(t *testing.T) {
	for _, ca := range []struct {
		name   string
		tracks []conf.AlwaysAvailableTrack
		desc   *description.Session
		err    string
	}{
		{
			"wrong tracks",
			[]conf.AlwaysAvailableTrack{
				{Codec: "H264"},
				{Codec: "H265"},
			},
			&description.Session{
				Medias: []*description.Media{
					{
						Type:    description.MediaTypeVideo,
						Formats: []format.Format{&format.H264{}},
					},
				},
			},
			"wants to publish [H264], but stream expects [H264 H265]",
		},
		{
			"wrong mpeg-4 audio config",
			[]conf.AlwaysAvailableTrack{
				{Codec: "MPEG4Audio", SampleRate: 44100, ChannelCount: 2},
			},
			&description.Session{
				Medias: []*description.Media{
					{
						Type: description.MediaTypeAudio,
						Formats: []format.Format{&format.MPEG4Audio{
							Config: &mpeg4audio.AudioSpecificConfig{
								Type:          2,
								SampleRate:    48000,
								ChannelConfig: 1,
							},
						}},
					},
				},
			},
			"MPEG-4 audio configuration does not match, is type=2, sampleRate=48000, " +
				"channelCount=1, but stream expects type=2, sampleRate=44100, channelCount=2",
		},
		{
			"wrong g711 config",
			[]conf.AlwaysAvailableTrack{
				{Codec: "G711", MULaw: true, SampleRate: 8000, ChannelCount: 2},
			},
			&description.Session{
				Medias: []*description.Media{
					{
						Type: description.MediaTypeAudio,
						Formats: []format.Format{&format.G711{
							MULaw:        false,
							SampleRate:   8000,
							ChannelCount: 2,
						}},
					},
				},
			},
			"G711 configuration does not match, is MULaw=false, sampleRate=8000, " +
				"channelCount=2, but stream expects MULaw=true, sampleRate=8000, channelCount=2",
		},
		{
			"wrong lpcm config",
			[]conf.AlwaysAvailableTrack{
				{Codec: "LPCM", SampleRate: 44100, ChannelCount: 2},
			},
			&description.Session{
				Medias: []*description.Media{
					{
						Type: description.MediaTypeAudio,
						Formats: []format.Format{&format.LPCM{
							BitDepth:     16,
							SampleRate:   48000,
							ChannelCount: 2,
						}},
					},
				},
			},
			"LPCM configuration does not match, is bitDepth=16, sampleRate=48000, " +
				"channelCount=2, but stream expects bitDepth=16, sampleRate=44100, channelCount=2",
		},
	} {
		t.Run(ca.name, func(t *testing.T) {
			strm := &Stream{
				AlwaysAvailable:       true,
				AlwaysAvailableTracks: ca.tracks,
				WriteQueueSize:        512,
				RTPMaxPayloadSize:     1450,
				ReplaceNTP:            true,
				Parent:                &nilLogger{},
			}
			err := strm.Initialize()
			require.NoError(t, err)
			defer strm.Close()

			subStream := &SubStream{
				Stream:        strm,
				CurDesc:       ca.desc,
				UseRTPPackets: false,
			}
			err = subStream.Initialize()
			require.EqualError(t, err, ca.err)
		})
	}
}
